<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Technikraum – Server Chaos</title>
<link rel="stylesheet" href="style-server.css"/>
</head>
<body>
<h1>Technikraum – Server Chaos</h1>

<div id="server-list">
  <div class="server-column" id="column-1">
    <h2>Rack 1</h2>
  </div>
  <div class="server-column" id="column-2">
    <h2>Rack 2</h2>
  </div>
  <div class="server-column" id="column-3">
    <h2>Rack 3</h2>
  </div>
</div>

<button id="restart-all">Alle Server neu starten</button>
<div id="message">Klicke auf einen Server, um ihn zu starten oder zu reparieren.</div>

<script>
const columns = [
  document.getElementById('column-1'),
  document.getElementById('column-2'),
  document.getElementById('column-3')
];

const messageEl = document.getElementById('message');
const restartAllBtn = document.getElementById('restart-all');

const servers = [
  { id: 1, name: "Alpha", device: "Kaffeemaschine", status: "ok" },
  { id: 2, name: "Beta", device: "Mikrowelle", status: "ok" },
  { id: 3, name: "Gamma", device: "WLAN-Router", status: "ok" },
  { id: 4, name: "Delta", device: "Drucker", status: "ok" },
  { id: 5, name: "Epsilon", device: "Scanner", status: "ok" },
  { id: 6, name: "Zeta", device: "Faxgerät", status: "ok" },
  { id: 7, name: "Eta", device: "Lichtsteuerung", status: "ok" },
  { id: 8, name: "Theta", device: "Kühlschrank", status: "ok" },
  { id: 9, name: "Iota", device: "Türsteuerung", status: "ok" },
  { id: 10, name: "Kappa", device: "Sicherheitskamera", status: "ok" },
  { id: 11, name: "Lambda", device: "TV im Pausenraum", status: "ok" },
  { id: 12, name: "Mu", device: "Radioanlage", status: "ok" },
  { id: 13, name: "Nu", device: "Zeiterfassung", status: "ok" },
  { id: 14, name: "Xi", device: "Ventilator", status: "ok" },
  { id: 15, name: "Omikron", device: "Beamer", status: "ok" },
  { id: 16, name: "Pi", device: "Klimaanlage", status: "ok" },
  { id: 17, name: "Rho", device: "Aktenvernichter", status: "ok" },
  { id: 18, name: "Sigma", device: "Laserdrucker", status: "ok" },
  { id: 19, name: "Tau", device: "Bluetooth-Hub", status: "ok" },
  { id: 20, name: "Upsilon", device: "Thermokanne", status: "ok" },
  { id: 21, name: "Phi", device: "Projektor", status: "ok" },
  { id: 22, name: "Chi", device: "Konferenzmikrofon", status: "ok" },
  { id: 23, name: "Psi", device: "Serverlüftung", status: "ok" },
  { id: 24, name: "Omega", device: "Zugangskontrolle", status: "ok" }
];

const serverDivs = new Map();
const serverIntervals = new Map();

function randomError() {
  const healthy = servers.filter(s => s.status === "ok");
  if (healthy.length === 0) return;
  const rand = healthy[Math.floor(Math.random() * healthy.length)];
  rand.status = "error";
}
randomError();

function initServers() {
  columns.forEach(col => col.innerHTML = "");

  servers.forEach((server, i) => {
    const targetColumn = columns[i % 3];

    const serverDiv = document.createElement('div');
    serverDiv.className = 'server';
    serverDiv.style.cursor = 'pointer';
    serverDiv.setAttribute('data-id', server.id);

    const title = document.createElement('h3');
    title.textContent = server.name;

    const ledGroup = document.createElement('div');
    ledGroup.classList.add('led-group');

    for (let j = 0; j < 12; j++) {
      const led = document.createElement('div');
      led.classList.add('led');
      ledGroup.appendChild(led);
    }

    serverDiv.appendChild(title);
    serverDiv.appendChild(ledGroup);

    serverDiv.addEventListener('click', () => {
      handleServerClick(server.id);
    });

    targetColumn.appendChild(serverDiv);
    serverDivs.set(server.id, serverDiv);
  });
}

// LEDs aktualisieren, Intervall managen
function clearServerIntervals(serverId) {
  if (!serverIntervals.has(serverId)) return;
  serverIntervals.get(serverId).forEach(id => clearInterval(id));
  serverIntervals.delete(serverId);
}

function updateServerStatus(server) {
  const serverDiv = serverDivs.get(server.id);
  if (!serverDiv) return;

  const ledGroup = serverDiv.querySelector('.led-group');
  const leds = ledGroup.children;

  clearServerIntervals(server.id);

  for (let j = 0; j < leds.length; j++) {
    const led = leds[j];
    led.className = 'led';
    led.style.animation = '';

    switch (server.status) {
      case "booting":
        led.classList.add('led-orange');
        led.style.animation = "blink-sync 1s infinite";
        break;

      case "ok":
        const color = Math.random() > 0.5 ? 'led-green' : 'led-red';
        led.classList.add(color, 'led-on');

        const intervalId = setInterval(() => {
          const srv = servers.find(s => s.id === server.id);
          if (!srv || srv.status !== "ok") {
            clearInterval(intervalId);
            return;
          }
          const newColor = Math.random() > 0.5 ? 'led-green' : 'led-red';
          led.className = 'led ' + newColor + ' led-on';
        }, Math.random() * 200 + 50);

        if (!serverIntervals.has(server.id)) serverIntervals.set(server.id, []);
        serverIntervals.get(server.id).push(intervalId);
        break;

      case "error":
        led.classList.add('led-red');
        led.style.animation = "blink-error 0.5s infinite steps(1)";
        break;

      case "maintenance":
        led.classList.add('led-orange');
        led.style.animation = `blink-error 0.5s infinite steps(1)`;
        led.style.animationDelay = `${j * 0.5}s`;
        break;

      case "off":
      default:
        led.classList.add('led-gray');
        break;
    }
  }
}

function handleServerClick(id) {
  const server = servers.find(s => s.id === id);

  if (server.status === "error") {
    server.status = "maintenance";
    updateServerStatus(server);
    setMessage(`🔧 Repariere ${server.name}...`);
    setTimeout(() => {
      const isError = Math.random() < 0.25;
      server.status = isError ? "error" : "ok";
      updateServerStatus(server);
      setMessage(isError ? `⚠️ Reparatur fehlgeschlagen bei ${server.name}` : `✅ ${server.name} wieder betriebsbereit`);
    }, 6000);
    return;
  }

  if (server.status === "off") {
    server.status = "booting";
    updateServerStatus(server);
    setMessage(`🚀 Starte ${server.name}...`);
    setTimeout(() => {
      const isError = Math.random() < 0.25;
      server.status = isError ? "error" : "ok";
      updateServerStatus(server);
      setMessage(isError ? `💥 Fehler beim Start von ${server.name}` : `✅ ${server.device} wieder verbunden`);
    }, 3000);
    return;
  }

  const hasErrors = servers.some(s => s.status === "error");
  if (!hasErrors) {
    server.status = "off";
    updateServerStatus(server);
    setMessage(`❌ Verbindung zu ${server.device} verloren`);
  } else {
    setMessage(`🚫 Kann ${server.name} nicht ausschalten, solange Fehler bestehen.`);
  }
}

function setMessage(text) {
  messageEl.textContent = text;
}

restartAllBtn.addEventListener('click', () => {
  setMessage("⏳ Server werden nacheinander heruntergefahren...");

  const shuffledShutdown = [...servers];
  shuffleArray(shuffledShutdown);

  shuffledShutdown.forEach((server, index) => {
    setTimeout(() => {
      server.status = "off";
      updateServerStatus(server);
      setMessage(`⛔ ${server.name} heruntergefahren`);
    }, index * 100);
  });

  const totalShutdownTime = shuffledShutdown.length * 60;

  setTimeout(() => {
    setMessage("🕒 Warte 5 Sekunden vor Neustart...");

    setTimeout(() => {
      const shuffledReboot = [...servers];
      shuffleArray(shuffledReboot);

      let errorCount = 0;

      shuffledReboot.forEach((server, index) => {
        setTimeout(() => {
          server.status = "booting";
          updateServerStatus(server);
          setMessage(`🔄 Starte ${server.name}...`);
        }, index * 500);

        setTimeout(() => {
          const shouldError = Math.random() < 0.3 && errorCount < 5;
          if (shouldError) {
            server.status = "error";
            errorCount++;
            setMessage(`💥 Fehler beim Start von ${server.name}`);
          } else {
            server.status = "ok";
            setMessage(`✅ ${server.device} verbunden`);
          }
          updateServerStatus(server);
        }, index * 500 + 700);
      });
    }, 5000);
  }, totalShutdownTime);
});

function shuffleArray(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

initServers();
servers.forEach(updateServerStatus);

</script>
</body>
</html>
